% Pedro ------------------------------------------------------------------------
\begin{section}{C: LAMP}
\label{app:lamp}
Com a sensível complexidade dos comandos usados para a comunicação com a TV
devido ao número de campos e a diferença entre eles, foi-se adotado um banco de
ados para armazenar informações sobre os aparelhos, bem como seus comandos. Isso
evitará possíveis problemas de escalabilidade quando o sistema evoluir para o
controle de diversos equipamentos eletrônicos.

% Pedro: o abaixo deveria estar em 'trabalhos futuros'
Além disso, visando uma integração maior do sistema implementado no BeagleBone
Black$^{\scriptsize{\textregistered}}$, a adoção de um servidor Apache com PHP
será necessária. Essa integração se dá pela criação de uma página web onde serão
armazenados dados provenientes das interação do sistema, por exemplo, caso o
usuário tenha ligado a TV, mudado de canal ou desligado o ar condicionado, todas
essas informação poderão ir para um \textit{log} de uma página web em que pode
ser acessado pelo desenvolvedor para investigar a performance do sistema. Além
do \textit{log} de comandos executados pelo usuário, podemos guardar erros
cometidos pelo Julius, ou eSpeak ou ainda falha no envio do comando para o
aparelho eletrônico, em casos mais específicos o usuário poderá até ligar
aparelhos remotamente ou o desenvolvedor avaliar o desempenho do sistema e
identificando problemas antes de uma visita técnica.

Para integrar todos estes recursos é necessário um sistema operacional que, no
caso, é um Linux Debian, configurando assim o servidor LAMP (Linux,
Apache HTTP Server, MySQL e PHP). Após a instalação das dependências e
subsequente configuração, o acesso e comunicação com o MySQL via códigos em C
foi necessário. Para tal, a biblioteca \texttt{mysql.h} é usada. No código em C
para a comunicação, foram criadas 8 funções específicas, sendo elas mostradas na
Lista~\ref{lst:dbphi0}.

% Code
\lstinputlisting[style=code, language=c, firstline=8, lastline=32,
caption={Definição das funções}, label={lst:dbphi0}]
{codes/bbb/db_phi.c}

\newpage
A Lista~\ref{lst:dbphi2} mostra a função \texttt{get\_element()}, responsável
por fazer a \textit{fetch} no banco de dados. Ela retornará o valor do atributo
específico que se deseja obter, recebendo como parâmetros a coluna e a marca,
bem como a conexão com o MySQL. Com isso, pode-se selecionar o atributo
\textit{field} onde a marca é igual ao \textit{branch} passado à função. Feito
isso, a função \texttt{mysql\_fetch\_row()} é chamada para retornar todos os
valores que satisfazem a condição exigida pela \textit{query}, o qual, para esse
caso especifico, será um valor único. Pode-se notar que o comando passado à
consulta é simplemente um \textit{select} filtrado com a cláusula
\textit{where}, tal como mostrado abaixo:

\begin{lstlisting}[language=sql]
SELECT field FROM tv WHERE marca='branch'
\end{lstlisting}

% Code
\lstinputlisting[style=code, language=c, firstline=39, lastline=76, 
caption={Função \texttt{get\_element()}}, label={lst:dbphi2}]
{codes/bbb/db_phi.c}\vspace{.5cm}

As demais funções basicamente chamam a função \texttt{mysql\_query()}, a qual
recebe como parâmetros a conexão com o banco e uma \textit{string} contendo o 
comando SQL. A função \texttt{setup()}, mostrada na Lista~\ref{lst:dbphi9} foi 
criada para configurar o banco de dados de acordo com as necessidades deste
trabalho, utilizando tanto funções nativas da biblioteca usada quanto as criadas
manualmente para algumas ações específicas. Essa função, se traduzida
literalmente para seu código SQL, resultaria na sequência de comandos descritos
na Lista~\ref{lst:dbphi_sql}.

% Code: SQL
\lstinputlisting[style=code, language=sql, firstline=1, lastline=32, 
caption={Código SQL para configuração do MySQL}, label={lst:dbphi_sql}]
{codes/bbb/setup_db.sql}

% Code: setup
\lstinputlisting[style=code, language=c, firstline=228, lastline=264, 
caption={Função \texttt{setup()}}, label={lst:dbphi9}]
{codes/bbb/db_phi.c}
\end{section}

% Thiago -----------------------------------------------------------------------
\newpage
\begin{section}{Arduino: IR Tx/Rx}
\label{app:arduino}

\lstinputlisting[style=code, language=c, firstline=40, lastline=76,
caption={Função {\tt ir\_dump()}}, label={lst:ard_2}]
{codes/arduino/arduino_IR.ino}

\lstinputlisting[style=code, language=c, firstline=90, lastline=104,
caption={Função {\tt mark()}}, label={lst:ard_4}]
{codes/arduino/arduino_IR.ino}
\end{section}

%% Cassio -----------------------------------------------------------------------
%\newpage
%\begin{section}{Matlab/Octave: Analisador de Onda Quadrada}
%\label{app:matlab}
%\lstinputlisting[style=code, language=matlab]{codes/matlab/myanalyze.m}
%\end{section}

%% Cassio -----------------------------------------------------------------------
%\newpage
%\begin{section}{C: RC-6 \textit{Handler}}
%\label{app:rc6}
%\lstinputlisting[style=code, language=c, firstline=57, lastline=67,
%caption={Declaração das funções}, label={lst:ir_0}]
%{codes/bbb/ir_pwm.c}
%
%\lstinputlisting[style=code, language=c, firstline=133, lastline=211,
%caption={Função \texttt{decode()}}, label={lst:ir_1}]
%{codes/bbb/ir_pwm.c}
%
%\lstinputlisting[style=code, language=c, firstline=220, lastline=278,
%caption={Função \texttt{send()}}, label={lst:ir_1}]
%{codes/bbb/ir_pwm.c}
%
%\lstinputlisting[style=code, language=c, firstline=281, lastline=323,
%caption={Função \texttt{receive()}}, label={lst:ir_1}]
%{codes/bbb/ir_pwm.c}
%\end{section}

% Cassio -----------------------------------------------------------------------
\newpage
\begin{section}{Protocolo de Comunicação Duplex entre Arduino e BBB}
\label{app:duplex}
Como já mencionado, muitos problemas impediram que o envio do sinal IR fosse 
implementado diretamente na BeagleBone. Assim, a solução adotada foi transmitir
os bits de comando, através de pinos, do servidor para o Arduino, o qual possui
um código bem funcional para o envio de sinais IR via PWM.

\subsection{Rx: UNO}
\lstinputlisting[style=code, language=c, firstline=30, lastline=71,
caption={Código do Arduino, o qual recebe um \textit{bitstream} de 34 bits}, 
label={lst:duplex_0}]
{codes/arduino/DuplexTransmission.ino}

\subsection{Tx: BBB}
\lstinputlisting[style=code, language=c, %firstline=57, lastline=67,
caption={Código em C, o qual envia um \textit{bitstream} de 34 bits}, 
label={lst:duplex_1}]
{codes/bbb/send2uno.c}
\end{section}

%%% EOF %%%
